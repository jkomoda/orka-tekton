---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: parallel-deploy
spec:
  workspaces:
    - name: shared-data
  tasks:
    - name: setup
      taskRef:
        name: orka-init
      params:
        - name: orka-api-url
          value: http://10.10.10.100
        - name: base-image
          value: catalina-ssh-30G.img
    - name: diskinfo
      retries: 1
      taskRef:
        name: orka-deploy
      params:
        - name: orka-api-url
          value: http://10.10.10.100
        - name: ssh-username
          value: admin
        - name: copy-build
          value: "false"
        - name: script
          value: |
            diskutil info /
      workspaces:
        - name: orka
          workspace: shared-data
    - name: ruby
      retries: 1
      taskRef:
        name: orka-deploy
      params:
        - name: orka-api-url
          value: http://10.10.10.100
        - name: ssh-username
          value: admin
        - name: copy-build
          value: "false"
        - name: script
          value: |
            #!/usr/bin/env ruby
            puts "Hello macOS"
      workspaces:
        - name: orka
          workspace: shared-data
  finally:
    - name: cleanup
      taskRef:
        name: orka-teardown
      params:
        - name: orka-api-url
          value: http://10.10.10.100
---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: run-parallel-deploy
spec:
  serviceAccountName: orka-svc
  pipelineRef:
    name: parallel-deploy
  workspaces:
    - name: shared-data
      emptyDir: {}
